<!doctype html>
{% load static %}

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Embedding a Bokeh Server With {{ framework }}</title>
  <link rel="stylesheet" href={% static "covid_tracker/covid_css.css" %}>
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-2.1.1.min.js"
        crossorigin="anonymous"></script>
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.1.1.min.js"
          crossorigin="anonymous"></script>
  <script src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.1.1.min.js"
          crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  {% csrf_token %}
  <script type="text/javascript">

    const states_dict = JSON.parse("{{ states|escapejs }}");
    const states_list = Object.keys(states_dict);

    function addFiltersToUri(uri, filters) {
      var finalUri = uri;
      var filterSuffixUri;
      var first = true;
      for (var key in filters) {
        if (filters.hasOwnProperty(key)) {
          if (first) {
            filterSuffixUri = key + '=' + filters[key];
            first = false;
          } else {
            filterSuffixUri = filterSuffixUri + '&' + key + '=' + filters[key];
          }
        }
      }
      finalUri = finalUri + '?' + filterSuffixUri;
      return finalUri;
    }

    function updateChart(divId, uri, filters) {

      let divIdWithHash = '#' + divId;
      var chart_div = document.querySelector(divIdWithHash);
      var finalUri = addFiltersToUri(uri, filters)

      // show pre-loading
      // chart_div.innerHTML = "<img style=\"height:400px\" src={% static 'covid_tracker/assets/pre-loader-1.gif' %}>";
      chart_div.innerHTML = "<iframe src=\"https://giphy.com/embed/dUf4MkUk6GpuMDrNbj\" width=\"100%\" height=\"100%\" style=\"position:absolute\" frameBorder=\"0\" class=\"giphy-embed\" allowFullScreen></iframe>"


      fetch(finalUri)
                .then(function (response) {
                    return response.json();
                })
                .then(function (item) {
                    var chart_div = document.querySelector(divIdWithHash);
                    chart_div.innerHTML = "";
                    Bokeh.embed.embed_item(item, divId);
                    chart_div.setAttribute('data-url', finalUri);
                }).catch((error) => {
                    var chart_div = document.querySelector(divIdWithHash);
                    chart_div.innerHTML = "<img style=\"height:300px;width:400px\" src={% static 'airpollution/assets/img/tech-snag.png' %}>";
                    chart_div.setAttribute('data-url', finalUri);
                });

    }

    function determine_filters(data_group_class) {
      var elem_list = document.getElementsByClassName(data_group_class);
      var filters = {};
      for (let i = 0; i < elem_list.length; i++) {
        filters[elem_list[i].dataset.key] = elem_list[i].dataset.value.toLowerCase();
      }

      return filters;
    }

    function determine_and_update(chartId, data_group_class, uri) {
      var updates_filters = determine_filters(data_group_class);
      console.log(updates_filters)
      updateChart(chartId, uri, updates_filters);
    }


    function update_counties(state, county_id, data_group_class, target_chart, chart_update_url, chart_name) {
      // when a new state is selected, this function will update
      // the counties dropdown list.
      var county_sel = document.getElementById(county_id).getElementsByClassName('dropdown-menu')[0];
      var data_div = document.getElementById(county_id).getElementsByClassName(data_group_class)[0];
      var btn = document.getElementById(county_id).getElementsByClassName('btn')[0]

      btn.disabled = true;
      var btn_span = document.createElement('span');
      btn_span.className = "spinner-border spinner-border-sm text-light";
      btn_span.role = 'status';
      btn.appendChild(btn_span);
      btn.innerText = 'loading...';

      // clear the exiting list
      while (county_sel.firstChild) {
        county_sel.removeChild(county_sel.firstChild);
      }

      // get the counties for the selected state
      // fetch('/get_counties?state=' + state)
      //     .then(response => {
      //       return response.json();
      //     })
      //     .then(counties_list => {

      const counties_list = states_dict[state];

      var opt;
      for (var county in counties_list) {
        opt = document.createElement('a');
        opt.className = 'dropdown-item';
        opt.href = '#' + chart_name;
        opt.innerText = counties_list[county];
        opt.onclick = (x) => {
          btn.innerText = x.target.text;
          btn.setAttribute('data-value', x.target.text);
          determine_and_update(target_chart, data_group_class, chart_update_url);
        }
        county_sel.appendChild(opt);
        //   }
        // })
        // .then(() => {
        data_div.innerText = 'All';
        data_div.setAttribute('data-value', 'All');
        btn.disabled = false;
        //   })
        // .catch( error => console.log(error));
      }
    }

    function make_county_dropdown(data_group_class, add_to_div, target_chart, chart_update_url, button_label, chart_name) {
      make_button_dropdown(data_group_class, add_to_div, target_chart, chart_update_url, {'county': ['All']}, button_label, chart_name)
    }

    function make_exclcounty_dropdown(data_group_class, add_to_div, target_chart, chart_update_url, button_label, chart_name) {
      make_multibutton_dropdown(data_group_class, add_to_div, target_chart, chart_update_url, {'county': ['All']}, button_label, chart_name)
    }

    function make_state_dropdown(data_group_class, add_to_div, target_chart, chart_update_url, button_label, chart_name) {
      // fetch('/get_states')
      //   .then(response => {
      //     return response.json();
      //   })
      //   .then(states_list => {
          const states_wo_totalUS = states_list.slice(1, states_list.length);
          make_button_dropdown(data_group_class, add_to_div, target_chart, chart_update_url, {'state': states_wo_totalUS}, button_label, chart_name);
        //   })
        // .catch( (error) => console.log(error))
    }

    function make_slider(data_group_class, add_to_div, target_chart, chart_update_url, key_value_name, slider_title, values_dict, chart_name) {
      // values_dict = {'min': , 'max':, 'value': }
      var slider_div = document.createElement('div');
      slider_div.className = 'my-3';

      var slider_id = data_group_class + '_slider';
      var slider_label = document.createElement('label');
      slider_label.for = slider_id;
      slider_label.innerText = slider_title;
      var slider_span = document.createElement('span');
      slider_span.id = slider_id + '_days';
      slider_span.innerText = values_dict['value'].toString();
      slider_label.appendChild(slider_span);
      var slider_input = document.createElement('input');
      slider_input.type = 'range';
      slider_input.min = values_dict['min'].toString();
      slider_input.max = values_dict['max'].toString();
      slider_input.value = values_dict['value'].toString();
      slider_input.id = slider_id;
      slider_input.className = 'slider ' + data_group_class;
      slider_input.setAttribute('data-key', key_value_name);
      slider_input.setAttribute('data-value', slider_input.value);
      slider_input.oninput = x => {
                                    slider_span.innerText = x.target.value;
                                  };
      slider_input.onchange = x => {
                                slider_span.innerText = x.target.value;
                                slider_input.setAttribute('data-value', slider_input.value);
                                determine_and_update(target_chart, data_group_class, chart_update_url);
                              };

      // build new slider div and append to page
      slider_div.appendChild(slider_label);
      slider_div.appendChild(slider_input);
      document.getElementById(add_to_div).appendChild(slider_div);

    }

    function make_button_dropdown(data_group_class, add_to_div, target_chart, chart_update_url, sel_options, button_label, chart_name) {
      var key = Object.keys(sel_options)[0];
      var options = sel_options[key];

      var row_div = document.createElement('div');
      row_div.className = 'row';
      row_div.style = 'display: block';
      var dropdown_div = document.createElement('div');
      row_div.appendChild(dropdown_div)
      dropdown_div.className = 'dropdown show';
      dropdown_div.style = 'display: block';

      var new_label = document.createElement('label');
      new_label.innerText = button_label;
      dropdown_div.appendChild(new_label)

      var new_btn = document.createElement('div');
      new_btn.className = 'btn btn-sm btn-success btn-block dropdown-toggle ' + data_group_class;
      new_btn.href = '#';
      new_btn.role = 'button';
      new_btn.setAttribute('data-toggle', 'dropdown');
      new_btn.setAttribute('data-key', key);
      new_btn.setAttribute('data-value', options[0]);
      new_btn.setAttribute('aria-haspopup', 'true');
      new_btn.setAttribute('aria-expanded', 'false');
      new_btn.innerText = options[0];
      dropdown_div.appendChild(new_btn);

      var new_menu = document.createElement('div');
      new_menu.className = 'dropdown-menu';
      new_menu.setAttribute('aria-labelledby', 'dropdownMenuLink');
      dropdown_div.appendChild(new_menu);

      var elem;
      for (var i in options) {
        elem = document.createElement('a');
        elem.className = 'dropdown-item';
        elem.href = '#' + chart_name;
        elem.innerText = options[i];
        elem.onclick = (x) => {
                                var county_id = document.getElementById(add_to_div).dataset.county_id;
                                if (county_id) {
                                  document.getElementById(county_id).getElementsByClassName(data_group_class)[0].setAttribute('data-value', 'All');
                                  document.getElementById(county_id).getElementsByClassName(data_group_class)[0].innerText = 'All';
                                  update_counties(x.target.text, county_id, data_group_class, target_chart, chart_update_url, chart_name);
                                }
                                new_btn.innerText = x.target.text;
                                new_btn.setAttribute('data-value', x.target.text);
                                determine_and_update(target_chart, data_group_class, chart_update_url);
                              }
        new_menu.appendChild(elem);
      }
      document.getElementById(add_to_div).appendChild(row_div);
    }

    function make_multibutton_dropdown(data_group_class, add_to_div, target_chart, chart_update_url, sel_options, button_label, chart_name) {
      var key = Object.keys(sel_options)[0];
      var options = sel_options[key];

      var row_div = document.createElement('div');
      row_div.className = 'row';
      row_div.style = 'display: block';
      var dropdown_div = document.createElement('div');
      row_div.appendChild(dropdown_div)
      dropdown_div.className = 'dropdown show';
      dropdown_div.style = 'display: block';

      var new_label = document.createElement('label');
      new_label.innerText = button_label;
      dropdown_div.appendChild(new_label)

      var new_btn = document.createElement('div');
      new_btn.className = 'btn btn-sm btn-success btn-block dropdown-toggle ' + data_group_class;
      new_btn.href = '#';
      new_btn.role = 'button';
      new_btn.setAttribute('data-toggle', 'dropdown');
      new_btn.setAttribute('data-key', key);
      new_btn.setAttribute('data-value', options[0]);
      new_btn.setAttribute('aria-haspopup', 'true');
      new_btn.setAttribute('aria-expanded', 'false');
      new_btn.innerText = options[0];
      dropdown_div.appendChild(new_btn);

      var new_menu = document.createElement('div');
      new_menu.className = 'dropdown-menu';
      new_menu.setAttribute('aria-labelledby', 'dropdownMenuLink');
      dropdown_div.appendChild(new_menu);

      var elem;
      for (var i in options) {
        elem = document.createElement('a');
        elem.className = 'dropdown-item';
        elem.href = '#' + chart_name;
        elem.innerText = options[i];
        elem.onclick = (x) => {
                                // var county_id = document.getElementById(add_to_div).dataset.county_id;
                                // if (county_id) {
                                //   document.getElementById(county_id).getElementsByClassName(data_group_class)[0].setAttribute('data-value', 'All');
                                //   document.getElementById(county_id).getElementsByClassName(data_group_class)[0].innerText = 'All';
                                //   update_counties(x.target.text, county_id, data_group_class, target_chart, chart_update_url);
                                // }
                                // new_btn.innerText = x.target.text;
                                // new_btn.setAttribute('data-value', x.target.text);
                                // determine_and_update(target_chart, data_group_class, chart_update_url);
                              }
        new_menu.appendChild(elem);
      }
      document.getElementById(add_to_div).appendChild(row_div);
    }

    function make_chart(default_filters, chart_name, chart_title, chart_update_url){

      const data_group_name = chart_name + '_data_group';

      // create a controls and chart divs
      var section_div = document.createElement('div');
      section_div.className = 'container m-3';
      section_div.id = chart_name;

      var title = document.createElement('h3');
      title.className = 'row p-2';
      title.style = 'background-color: darkseagreen';
      title.innerText = chart_title;
      section_div.appendChild(title);

      var content_div = document.createElement('div');
      content_div.className = 'row';
      section_div.appendChild(content_div);

      var controls_div = document.createElement('div');
      controls_div.className = 'col-2 mt-2';
      controls_div.id = chart_name + '_controls';
      content_div.appendChild(controls_div);

      var chart_div = document.createElement('div');
      chart_div.className = 'col-10';
      chart_div.id = chart_name + '_chart';
      content_div.appendChild(chart_div);

      document.body.appendChild(section_div);

      // make a region section with a state if 'state' exists
      if (default_filters.hasOwnProperty('state')){
        var region_div = document.createElement('div');
        region_div.id = controls_div.id + '_regions';
        region_div.className = 'mb-3';
        controls_div.appendChild(region_div);

        var state_div = document.createElement('div');
        state_div.id = region_div.id + '_state';
        region_div.appendChild(state_div);

        make_state_dropdown(data_group_name, state_div.id, chart_div.id, chart_update_url, 'State: ', chart_name);

      }

      // make a county section if 'county' exists - tie it to state
      if (default_filters.hasOwnProperty('county')){
        var county_div = document.createElement('div');
        region_div.appendChild(county_div);
        county_div.id = region_div.id + '_county';
        state_div.setAttribute('data-county_id', county_div.id);

        make_county_dropdown(data_group_name, county_div.id, chart_div.id, chart_update_url, 'County: ', chart_name);
      }

      // make an exclude county section is 'exclude_counties' exists - tie it to state
      if (default_filters.hasOwnProperty('exclude_counties')){
        var excl_county_div = document.createElement('div');
        region_div.appendChild(excl_county_div);
        excl_county_div.id = region_div.id + '_exclcounties';
        state_div.setAttribute('data-exclcounties_id', excl_county_div.id);

        make_exclcounty_dropdown(data_group_name, excl_county_div.id, chart_div.id, chart_update_url, 'Exclude Counties: ', chart_name);
      }

      // make slider if 'rolling_window' exists
      if (default_filters.hasOwnProperty('rolling_window')){
        make_slider(data_group_name, controls_div.id, chart_div.id, chart_update_url, 'rolling_window', 'Rolling Avg Days: ', {'min': 1, 'max': 21, 'value': 14}, chart_name);
      }

      // make slider if 'top_n' exists
      if (default_filters.hasOwnProperty('top_n')){
        make_slider(data_group_name, controls_div.id, chart_div.id, chart_update_url, 'top_n', 'Top n Counties: ', {'min': 1, 'max': 15, 'value': 10}, chart_name);
      }

      // make frequency button if 'frequency' exists
      if (default_filters.hasOwnProperty('frequency')) {
        make_button_dropdown(data_group_name, controls_div.id, chart_div.id, chart_update_url, {'frequency': ['Daily', 'Cumulative']}, 'Frequency: ', chart_name);
      }

      // make data_type button if 'data_type' exists
      if (default_filters.hasOwnProperty('data_type')) {
        make_button_dropdown(data_group_name, controls_div.id, chart_div.id, chart_update_url, {'data_type': ['Infections', 'Deaths']}, 'Data Type: ', chart_name);
      }

      updateChart(chart_div.id, chart_update_url, default_filters);

    }


    // On load - draw default table
    document.addEventListener('DOMContentLoaded', () => {

      fetch('/refresh_git')
        .then(response => console.log(response.json()))
        .then(() => {
          // infections by state
          var filters = {
            'state': 'United States',
            'county': 'All',
            'frequency': 'daily',
            'data_type': 'Infections',
            'rolling_window': 14
          };
          make_chart(filters, 'state_totals', 'State Totals', '/state_chart/');
        })
        .then(() => {
          // infections by county
          var filters = {
            'state': 'Massachusetts',
            // 'exclude_counties': null,
            'top_n': 10,
            'data_type': 'Infections'
          }
          make_chart(filters, 'state_by_county', 'Counties by State', '/state_by_county_chart/');
        })
        .then(() => {
          // numbers by political affiliation of states
          var filters = { 'frequency': 'daily',
                          'data_type': 'infections',
                          'rolling_window': 14,
                          // 'exclude_states': null
                        }
          make_chart(filters, 'pollitical_affiliation', 'Political Affiliation', '/political_affiliation/');
        })
        .then(() => {
          // numbers by top states
          var filters = { 'states': null,
                          'data_type': 'infections',
                          'top_n': 15,
                          // 'exclude_states': null
                        }
          make_chart(filters, 'top_states', 'Top States', '/top_states/');
        })
        .catch( error => console.log(error))

    });


  </script>
</head>

<body>
  <div class="header" id="paypalheader">
    <!--    https://www.w3schools.com/howto/howto_js_sticky_header.asp-->
    <script>
      // When the user scrolls the page, execute myFunction
      window.onscroll = function() {myFunction()};

      // Get the header
      var header = document.getElementById("paypalheader");

      // Get the offset position of the navbar
      var sticky = header.offsetTop;

      // Add the sticky class to the header when you reach its scroll position.
      // Remove "sticky" when you leave the scroll position
      function myFunction() {
        if (window.pageYOffset > sticky) {
          header.classList.add("sticky");
        } else {
          header.classList.remove("sticky");
        }
      }
    </script>
    <div class="row m-3 justify-content-center">
      <button class="btn btn-warning" type="button" data-toggle="collapse" data-target="#collapsepaypal" aria-expanded="false" aria-controls="collapseExample">
        Like this? Show your appreciation!
      </button>
    </div>
    <div class="collapse" id="collapsepaypal">
      <div class="card card-body">
        <div class='row justify-content-center' id="paypal-button-container"></div>

        <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD" data-sdk-integration-source="button-factory"></script>
        <script>
          paypal.Buttons({
              style: {
                  shape: 'rect',
                  color: 'gold',
                  layout: 'horizontal',
                  label: 'paypal',
              },
              createOrder: function(data, actions) {
                  return actions.order.create({
                      purchase_units: [{
                          amount: {
                              value: '5'
                          }
                      }]
                  });
              },
              onApprove: function(data, actions) {
                  return actions.order.capture().then(function(details) {
                      alert('Transaction completed by ' + details.payer.name.given_name + '!');
                  });
              }
          }).render('#paypal-button-container');
        </script>
      </div>
    </div>
  </div>

</body>
</html>

